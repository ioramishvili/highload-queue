# Пример реализации очередей через RabbitMQ и Redis

Этот демо проект разработан на Yii2 Basic (php 8.2) и использует Docker для контейнеризации.
Дополнительные компоненты: Redis, RabbitMQ

## Как запустить проект

Чтобы запустить проект, выполните следующие шаги:

1. **Установите Docker**: Если у вас еще нет Docker, установите его, следуя официальным инструкциям на [сайте Docker](https://docs.docker.com/get-docker/).

2. **Установите Composer**: Если у вас еще нет Composer, установите его, следуя инструкциям на [сайте Composer](https://getcomposer.org/download/).

3. **Пропишите переменные окружения** Небходимо создать файл .env скопировав его из .env.prod. В файле .env необходимо указать значения переменных.

4. **Запустите контейнеры Docker**:
   - Склонируйте репозиторий проекта на свой компьютер.
   - Перейдите в корневую папку проекта и выполните следующую команду для запуска контейнеров Docker:

   ```bash
   docker-compose up -d
   ```

5. **Установите зависимости PHP**:
   - Выполните команду установки зависимостей PHP с помощью Composer:

   ```bash
   composer install
   ```

6. **Прописать алиас сайта**:
   - В файле /etc/hosts (c:\windows\system32\drivers\etc\hosts в случае Windows) прописать:

    ```bash
   127.0.0.1	local.highload-queue.ru
   ```

7. **Работа с сайтом**:
   - Теперь вы можете работать с сайтом, он доступен по адресу [http://local.highload-queue.ru/](http://local.highload-queue.ru/).
   
8. **Описание функционала**:
   - Реализовано два консьюмера (их можно сделать больше в зависимости от возможностей сервера). Для увеличения прописать в AccountsJob::KEYS дополнительные названия routing keys
   - Эти консьюмеры разбирают задачи из очереди, каждому юзеру назначается свой routing key, поэтому задания для одного пользователя разбирает только один консьюмер
   - Когда косьюмер берет задачу, то в кэш мы записываем routing key и используем его в дальнейшем
   - Конфиг RabbitMQ расположен в \config\queue.php

9. **Тест функционала**:
   - Перейти в SiteController.php и прописать в константах нужные значения для генерации сообщений
   - Выполнить команду  ```docker exec -it highload-queue-php bash```
   - В контейнере ```highload-queue-php``` выполнить команду ```php yii rabbitmq/consume common0``` и  ```php yii rabbitmq/consume common1``` для запуска консьюмеров
   - Открыть главную страницу http://local.highload-queue.ru/
   - Результат выполнения можно отслеживать на странице http://127.0.0.1:15672/ (Queues -> ACCOUNTS_JOB...)

## Лицензия

Этот проект распространяется под лицензией MIT.